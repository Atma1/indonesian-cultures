<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Peta Budaya Interaktif ‚Äî Papua (Dengan Mini Game Budaya)</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js"></script>
    <script src="https://unpkg.com/gsap@3.12.5/dist/gsap.min.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Inter:wght@400;600;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: #0a0f14;
      }
      #map {
        position: fixed;
        inset: 0;
      }
      .clouds-masked {
        position: absolute;
        z-index: 420;
        pointer-events: none;
        -webkit-mask-image: url("fog-mask.jpg");
        mask-image: url("fog-mask.jpg");
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        -webkit-mask-size: 100% 100%;
        mask-size: 100% 100%;
        -webkit-mask-position: center;
        mask-position: center;
      }
      .cloud-tex {
        position: absolute;
        inset: 0;
        opacity: 0.18;
        mix-blend-mode: screen;
        pointer-events: none;
        background-image: url("clouds.jpg");
        background-repeat: repeat;
        background-position: 0 0;
        will-change: background-position, background-size;
      }
      .cloud-tex.parallax {
        opacity: 0.12;
      }
      .leaflet-borders-pane {
        z-index: 450 !important;
      }
      .leaflet-icons-pane {
        z-index: 500 !important;
      }
      .prov-icon {
        width: 56px;
        height: 56px;
        border-radius: 999px;
        background: #0c1422cc;
        border: 1px solid #26354e;
        display: grid;
        place-items: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(4px);
        transition: transform 0.18s ease;
      }
      .prov-icon img {
        width: 44px;
        height: 44px;
        object-fit: contain;
      }
      .prov-icon:hover {
        transform: scale(1.08);
      }
      .icons-hidden .prov-icon {
        opacity: 0;
        transform: translateY(12px) scale(0.6);
        filter: blur(3px);
      }
      .backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
        z-index: 800;
      }
      .backdrop.active {
        opacity: 1;
        pointer-events: auto;
      }
      .sidebar {
        position: fixed;
        inset: 0 auto 0 0;
        width: min(420px, 92vw);
        height: 100dvh;
        background: #0b1220ea;
        color: #e5e7eb;
        border-right: 1px solid #1f2937;
        z-index: 900;
        transform: translateX(-110%);
        display: grid;
        grid-template-rows: auto 1fr auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(6px);
      }
      .sb-header {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid #132033;
      }
      .sb-header img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
      }
      .sb-header h2 {
        margin: 0;
        font: 700 18px/1.2 system-ui;
      }
      .sb-list {
        padding: 12px 16px;
        overflow: auto;
      }
      .chip {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 8px 10px;
        margin: 6px 6px 0 0;
        background: #0c1725;
        border: 1px solid #243147;
        border-radius: 999px;
        font: 500 13px/1.2 system-ui;
      }
      .chip img {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        object-fit: cover;
      }
      .sb-footer {
        padding: 10px 16px 14px;
        border-top: 1px solid #132033;
        color: #9fb0c6;
        font-size: 12px;
      }
      .hint {
        position: fixed;
        right: 12px;
        bottom: 12px;
        z-index: 700;
        background: #0b1220cc;
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 8px 10px;
        color: #aab7cc;
        font: 12px/1.2 system-ui;
      }
      .music-btn {
        position: fixed;
        right: 12px;
        bottom: 56px;
        z-index: 750;
        background: #0b1220cc;
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 8px 10px;
        color: #c7d2e0;
        font: 13px/1 system-ui;
        cursor: pointer;
        user-select: none;
        backdrop-filter: blur(6px);
      }
      .music-btn:hover {
        filter: brightness(1.08);
      }
      .onboard {
        position: fixed;
        inset: 0;
        z-index: 760;
        display: grid;
        place-items: center;
        background: radial-gradient(
            1200px 600px at 70% 100%,
            rgba(8, 12, 20, 0.6) 0%,
            rgba(8, 12, 20, 0.2) 60%,
            transparent 75%
          ),
          linear-gradient(180deg, rgba(7, 10, 16, 0.55), rgba(7, 10, 16, 0.55));
        color: #ede7d1;
      }
      .onboard-inner {
        width: min(1200px, 96vw);
        text-align: center;
        padding: 32px 20px;
      }
      .ob-subtitle {
        font: 600 14px/1 Inter, system-ui;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: #d0c6a5;
        margin-bottom: 10px;
      }
      .onboard h1 {
        margin: 0 0 10px;
        font: 800 clamp(52px, 8vw, 120px) / 1.03 "Cinzel", serif;
        letter-spacing: 0.015em;
        color: #f1e8ce;
        text-shadow: 0 4px 18px rgba(0, 0, 0, 0.35);
        white-space: nowrap;
        -webkit-font-smoothing: antialiased;
      }
      @media (max-width: 720px) {
        .onboard h1 {
          white-space: normal;
          line-height: 1.08;
        }
      }
      .onboard p {
        margin: 0 auto 24px;
        max-width: 900px;
        color: #decfae;
        font: 500 14px/1.65 Inter, system-ui;
      }
      .onboard-rule {
        display: block;
        margin: 14px auto 16px;
        width: min(760px, 92%);
        height: 23px;
      }
      .onboard .ob-subtitle,
      .onboard .onboard-rule,
      .onboard p,
      .onboard #btnExplore,
      .onboard #obTitle {
        opacity: 0;
        transform: translateY(24px);
      }
      .cta {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 14px 32px;
        min-width: 280px;
        border-radius: 6px;
        background: #1b1c20;
        border: 1px solid #c8aa6e;
        color: #fff;
        font: 700 14px/1 Inter, system-ui;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        user-select: none;
        transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 8px 22px rgba(0, 0, 0, 0.35);
      }
      .cta:hover {
        transform: translateY(-1px);
        filter: brightness(1.05);
      }
      .cta:active {
        transform: translateY(0);
        filter: brightness(0.97);
      }
      .cta .cta-label {
        position: relative;
        z-index: 1;
      }
      .dock {
        position: fixed;
        left: 50%;
        bottom: 14px;
        transform: translateX(-50%);
        z-index: 950;
        pointer-events: none;
      }
      .dock-inner {
        pointer-events: auto;
        display: flex;
        gap: 10px;
        align-items: flex-end;
        padding: 10px 14px;
        border-radius: 16px;
        background: linear-gradient(
          180deg,
          rgba(17, 21, 30, 0.6),
          rgba(12, 16, 24, 0.45)
        );
        border: 1px solid rgba(200, 170, 110, 0.28);
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45),
          inset 0 1px 0 rgba(255, 255, 255, 0.06);
        backdrop-filter: blur(10px) saturate(115%);
        position: relative;
        isolation: isolate;
        overflow: visible;
      }
      .dock-spotlight {
        position: absolute;
        inset: 0;
        border-radius: 16px;
        z-index: -1;
        pointer-events: none;
        background: radial-gradient(
          180px 80px at var(--x, 50%) 120%,
          rgba(200, 170, 110, 0.22),
          transparent 60%
        );
        transition: opacity 0.25s ease;
        opacity: 0;
      }
      .dock:hover .dock-spotlight {
        opacity: 1;
      }
      .dock-item {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        position: relative;
        transform-origin: 50% 100%;
        will-change: transform, filter;
      }
      .dock-item button {
        appearance: none;
        border: 0;
        background: transparent;
        padding: 0;
        margin: 0;
        width: 56px;
        height: 56px;
        display: grid;
        place-items: center;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
        transition: filter 0.18s ease;
      }
      .dock-item button:focus-visible {
        outline: 2px solid #c8aa6e88;
        outline-offset: 3px;
      }
      .dock-icon {
        width: 42px;
        height: 42px;
        object-fit: contain;
        filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.35));
        transition: transform 0.18s ease;
      }
      .dock-item::after {
        content: "";
        position: absolute;
        left: 8px;
        right: 8px;
        bottom: -14px;
        height: 10px;
        border-radius: 50%;
        background: radial-gradient(
          60% 100% at 50% 0%,
          rgba(0, 0, 0, 0.45),
          transparent 70%
        );
        filter: blur(6px);
        opacity: 0.7;
        transform: translateZ(0);
      }
      .dock-tip {
        position: absolute;
        bottom: 70px;
        left: 50%;
        transform: translateX(-50%) translateY(6px);
        padding: 6px 10px;
        border-radius: 8px;
        background: #0b1220e6;
        color: #e8e6d8;
        border: 1px solid #243147;
        font: 600 12px/1 Inter, system-ui;
        letter-spacing: 0.02em;
        white-space: nowrap;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.45);
        opacity: 0;
        pointer-events: none;
      }
      .dock-item.show-tip .dock-tip {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
        transition: all 0.18s ease;
      }
      .dock-underline {
        position: absolute;
        height: 3px;
        bottom: 6px;
        border-radius: 999px;
        background: linear-gradient(90deg, #b8944e, #e9d596, #b8944e);
        box-shadow: 0 0 12px rgba(200, 170, 110, 0.55);
        width: 40px;
        left: 0;
        opacity: 0;
      }
      .ripple {
        position: absolute;
        inset: 0;
        border-radius: 12px;
        overflow: hidden;
        pointer-events: none;
      }
      .ripple::before {
        content: "";
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 999px;
        left: var(--rx, 50%);
        top: var(--ry, 50%);
        background: radial-gradient(
          circle,
          rgba(233, 213, 150, 0.8),
          rgba(233, 213, 150, 0.35) 40%,
          transparent 60%
        );
        transform: translate(-50%, -50%) scale(1);
        filter: blur(1px);
      }
      @media (max-width: 560px) {
        .dock-inner {
          gap: 8px;
          padding: 8px 10px;
          border-radius: 14px;
        }
        .dock-item,
        .dock-item button {
          width: 50px;
          height: 50px;
        }
        .dock-icon {
          width: 38px;
          height: 38px;
        }
      }
      .qscrim {
        position: fixed;
        inset: 0;
        z-index: 980;
        background: rgba(7, 10, 16, 0.55);
        backdrop-filter: blur(2px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
      }
      .qscrim.active {
        opacity: 1;
        pointer-events: auto;
      }
      .qmodal {
        position: fixed;
        z-index: 990;
        left: 50%;
        top: 16%;
        transform: translateX(-50%);
        width: min(860px, 94vw);
        border-radius: 16px;
        background: rgba(15, 19, 28, 0.55);
        border: 1px solid rgba(200, 170, 110, 0.28);
        box-shadow: 0 30px 120px rgba(0, 0, 0, 0.55),
          0 2px 0 rgba(255, 255, 255, 0.06) inset;
        backdrop-filter: blur(18px) saturate(120%);
        contain: layout style paint;
        opacity: 0;
        filter: blur(10px);
        transform-origin: 50% 0%;
        pointer-events: none;
      }
      .qmodal.active {
        pointer-events: auto;
      }
      .qrow {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 16px;
        border-bottom: 1px solid #162338;
      }
      .qinput {
        width: 100%;
        padding: 14px 16px;
        border-radius: 12px;
        border: 1px solid #22324a;
        background: rgba(11, 17, 26, 0.65);
        color: #e8e6d8;
        font: 600 14px/1 Inter;
        outline: none;
      }
      .qinput::placeholder {
        color: #98a6bd;
        font-weight: 500;
      }
      .qk {
        align-self: center;
        color: #9fb0c6;
        font: 600 12px/1 system-ui;
        letter-spacing: 0.06em;
        padding: 8px 10px;
        border: 1px solid #22324a;
        border-radius: 10px;
      }
      .qlist {
        max-height: 54vh;
        overflow: auto;
        padding: 8px;
      }
      .qitem {
        display: grid;
        grid-template-columns: 36px 1fr auto;
        gap: 12px;
        align-items: center;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid transparent;
        transition: background 0.2s ease, border-color 0.2s ease,
          transform 0.12s ease;
      }
      .qitem:hover {
        background: #0c1725;
        border-color: #243147;
      }
      .qitem[aria-selected="true"] {
        outline: 2px solid #c8aa6e55;
      }
      .qicon {
        width: 36px;
        height: 36px;
        object-fit: contain;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
      }
      .qtitle {
        color: #e8e6d8;
        font: 700 14px/1.2 Inter;
      }
      .qdesc {
        color: #9fb0c6;
        font: 500 12px/1.35 Inter;
      }
      .qtag {
        color: #d9c89a;
        font: 700 11px/1 Inter;
        letter-spacing: 0.08em;
        border: 1px solid #3a2e16;
        padding: 6px 10px;
        border-radius: 999px;
        background: linear-gradient(
          180deg,
          rgba(200, 170, 110, 0.25),
          rgba(200, 170, 110, 0.12)
        );
      }
      .qfoot {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 10px 16px 14px;
        border-top: 1px solid #162338;
        color: #9fb0c6;
        font: 12px/1.2 system-ui;
      }
      .sscrim {
        position: fixed;
        inset: 0;
        z-index: 980;
        background: rgba(7, 10, 16, 0.55);
        backdrop-filter: blur(2px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
      }
      .sscrim.active {
        opacity: 1;
        pointer-events: auto;
      }
      .smodal {
        position: fixed;
        z-index: 990;
        left: 50%;
        top: 10%;
        transform: translateX(-50%);
        width: min(980px, 96vw);
        border-radius: 18px;
        background: rgba(15, 19, 28, 0.55);
        border: 1px solid rgba(200, 170, 110, 0.28);
        box-shadow: 0 30px 140px rgba(0, 0, 0, 0.6),
          0 2px 0 rgba(255, 255, 255, 0.06) inset;
        backdrop-filter: blur(22px) saturate(120%);
        contain: layout style paint;
        opacity: 0;
        filter: blur(10px);
        transform-origin: 50% 0%;
        pointer-events: none;
      }
      .smodal.active {
        pointer-events: auto;
      }
      .shead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 18px;
        border-bottom: 1px solid #162338;
      }
      .stitle {
        color: #f2ecd5;
        font: 800 18px/1.2 Inter;
        letter-spacing: 0.02em;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .sbadge {
        font: 700 11px/1 Inter;
        color: #1b1c20;
        background: #e9d596;
        border-radius: 999px;
        padding: 4px 8px;
      }
      .sbill {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #cbd5e1;
        font: 600 12px/1 Inter;
      }
      .switch {
        --h: 26px;
        position: relative;
        width: 64px;
        height: var(--h);
        border-radius: 999px;
        border: 1px solid #243147;
        background: #0c1725;
        cursor: pointer;
        user-select: none;
        display: inline-block;
      }
      .switch .knob {
        position: absolute;
        top: 2px;
        left: 2px;
        width: calc(var(--h) - 4px);
        height: calc(var(--h) - 4px);
        border-radius: 999px;
        background: linear-gradient(180deg, #e9d596, #b8944e);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.35);
        transition: left 0.22s ease;
      }
      .switch[data-on="true"] .knob {
        left: calc(100% - var(--h) + 2px);
      }
      .sbody {
        padding: 16px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 14px;
      }
      .card {
        position: relative;
        border-radius: 14px;
        border: 1px solid rgba(200, 170, 110, 0.22);
        background: linear-gradient(
          180deg,
          rgba(17, 21, 30, 0.6),
          rgba(12, 16, 24, 0.45)
        );
        padding: 16px;
        color: #e8e6d8;
        box-shadow: 0 16px 60px rgba(0, 0, 0, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.06);
        transition: transform 0.18s ease, box-shadow 0.18s ease,
          border-color 0.18s ease;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 22px 70px rgba(0, 0, 0, 0.45);
      }
      .card.active {
        border-color: #e9d596;
        box-shadow: 0 22px 90px rgba(0, 0, 0, 0.55);
      }
      .chead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .cname {
        font: 800 16px/1 Inter;
        letter-spacing: 0.02em;
      }
      .cbadge {
        font: 700 10px/1 Inter;
        letter-spacing: 0.08em;
        border: 1px solid #3a2e16;
        padding: 4px 8px;
        border-radius: 999px;
        background: linear-gradient(
          180deg,
          rgba(200, 170, 110, 0.25),
          rgba(200, 170, 110, 0.12)
        );
        color: #d9c89a;
      }
      .cprice {
        font: 800 26px/1 "Cinzel", serif;
        color: #f2ecd5;
        margin: 8px 0 2px;
      }
      .cunit {
        color: #b9c7da;
        font: 600 12px/1.2 Inter;
      }
      .clist {
        margin: 12px 0 14px;
        padding: 0;
        list-style: none;
      }
      .clist li {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 6px 0;
        color: #cbd5e1;
        font: 500 13px/1.45 Inter;
      }
      .clist li::before {
        content: "‚úî";
        color: #e9d596;
        font-weight: 700;
        margin-top: 2px;
      }
      .ccta {
        width: 100%;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid #c8aa6e;
        background: #1b1c20;
        color: #fff;
        font: 800 12px/1 Inter;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
      }
      .sfoot {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 10px 16px 14px;
        border-top: 1px solid #162338;
        color: #9fb0c6;
        font: 12px/1.2 system-ui;
      }
      .pscrim {
        position: fixed;
        inset: 0;
        z-index: 980;
        background: rgba(7, 10, 16, 0.55);
        backdrop-filter: blur(2px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
      }
      .pscrim.active {
        opacity: 1;
        pointer-events: auto;
      }
      .pmodal {
        position: fixed;
        z-index: 990;
        left: 50%;
        top: 8%;
        transform: translateX(-50%);
        width: min(920px, 96vw);
        border-radius: 20px;
        background: rgba(15, 19, 28, 0.55);
        border: 1px solid rgba(200, 170, 110, 0.28);
        box-shadow: 0 30px 140px rgba(0, 0, 0, 0.6),
          0 2px 0 rgba(255, 255, 255, 0.06) inset;
        backdrop-filter: blur(22px) saturate(120%);
        contain: layout style paint;
        opacity: 0;
        filter: blur(10px);
        transform-origin: 50% 0%;
        pointer-events: none;
      }
      .pmodal.active {
        pointer-events: auto;
      }
      .phead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 18px;
        border-bottom: 1px solid #162338;
      }
      .pheadL {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .pname {
        color: #f2ecd5;
        font: 800 18px/1.2 Inter;
        letter-spacing: 0.02em;
      }
      .pmeta {
        color: #9fb0c6;
        font: 600 12px/1 Inter;
      }
      .btn {
        appearance: none;
        border: 1px solid #243147;
        background: #0c1725;
        color: #e8e6d8;
        border-radius: 10px;
        padding: 10px 12px;
        font: 600 12px/1 Inter;
        cursor: pointer;
      }
      .btn:hover {
        filter: brightness(1.06);
      }
      .btn.gold {
        border-color: #c8aa6e;
        background: #1b1c20;
      }
      .danger {
        color: #ffb4b4;
        border-color: #6d2f2f;
        background: #2a0f14;
      }
      .pbody {
        display: grid;
        grid-template-columns: 0.9fr 1.1fr;
        gap: 16px;
        padding: 16px 18px;
      }
      @media (max-width: 900px) {
        .pbody {
          grid-template-columns: 1fr;
        }
        .pmodal {
          top: 4%;
        }
      }
      .pcol {
        background: linear-gradient(
          180deg,
          rgba(17, 21, 30, 0.6),
          rgba(12, 16, 24, 0.45)
        );
        border: 1px solid rgba(200, 170, 110, 0.18);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.38),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }
      .pcol.sticky {
        position: sticky;
        top: 16px;
        height: fit-content;
      }
      .avatar-drop {
        position: relative;
        display: grid;
        place-items: center;
        aspect-ratio: 1/1;
        border-radius: 16px;
        border: 1px dashed #384a64;
        background: rgba(11, 17, 26, 0.5);
        overflow: hidden;
        cursor: pointer;
      }
      .avatar-drop:hover {
        border-color: #c8aa6e66;
      }
      .avatar-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
      }
      .avatar-hint {
        text-align: center;
        color: #b9c7da;
        font: 600 12px/1.4 Inter;
        padding: 12px;
      }
      .avatar-hint b {
        color: #e9d596;
      }
      .avatar-initials {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        color: #c8aa6e;
        font: 900 clamp(28px, 6vw, 64px) / 1 "Cinzel", serif;
        letter-spacing: 0.02em;
      }
      .avatar-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      .fstack {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .fgroup {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .flabel {
        color: #b9c7da;
        font: 700 12px/1 Inter;
        letter-spacing: 0.06em;
      }
      .input {
        width: 100%;
        background: rgba(11, 17, 26, 0.65);
        color: #e8e6d8;
        border: 1px solid #22324a;
        border-radius: 14px;
        padding: 14px 16px;
        font: 600 14px/1.2 Inter;
        outline: none;
        transition: border-color 0.18s ease, box-shadow 0.18s ease,
          background 0.18s ease;
      }
      .input::placeholder {
        color: #97a6be;
        font-weight: 500;
      }
      .input:focus {
        border-color: #c8aa6e66;
        box-shadow: 0 0 0 3px rgba(200, 170, 110, 0.12);
      }
      .helper {
        color: #8ea0ba;
        font: 600 11px/1.2 Inter;
      }
      .pfoot {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 12px 18px 16px;
        border-top: 1px solid #162338;
      }
      .toast {
        position: fixed;
        left: 50%;
        bottom: 22px;
        transform: translateX(-50%) translateY(16px);
        background: #0b1220f2;
        border: 1px solid #243147;
        color: #dbe6f7;
        padding: 10px 14px;
        border-radius: 10px;
        font: 700 12px/1 Inter;
        opacity: 0;
        z-index: 999;
      }
      .gscrim {
        position: fixed;
        inset: 0;
        z-index: 980;
        background: rgba(7, 10, 16, 0.55);
        backdrop-filter: blur(2px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
      }
      .gscrim.active {
        opacity: 1;
        pointer-events: auto;
      }
      .gmodal {
        position: fixed;
        z-index: 990;
        left: 50%;
        top: 8%;
        transform: translateX(-50%);
        width: min(960px, 96vw);
        border-radius: 18px;
        background: rgba(15, 19, 28, 0.6);
        border: 1px solid rgba(200, 170, 110, 0.28);
        box-shadow: 0 30px 140px rgba(0, 0, 0, 0.6),
          0 2px 0 rgba(255, 255, 255, 0.06) inset;
        backdrop-filter: blur(22px) saturate(120%);
        contain: layout style paint;
        opacity: 0;
        filter: blur(10px);
        transform-origin: 50% 0%;
        pointer-events: none;
      }
      .gmodal.active {
        pointer-events: auto;
      }
      .ghead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 18px;
        border-bottom: 1px solid #162338;
      }
      .gtitle {
        color: #f2ecd5;
        font: 800 18px/1.2 Inter;
        letter-spacing: 0.02em;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .gstats {
        display: flex;
        gap: 12px;
        color: #cbd5e1;
        font: 700 12px/1 Inter;
      }
      .gstats .pill {
        border: 1px solid #243147;
        padding: 6px 10px;
        border-radius: 999px;
        background: #0c1725;
      }
      .gbody {
        padding: 16px 18px;
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 16px;
      }
      @media (max-width: 900px) {
        .gbody {
          grid-template-columns: 1fr;
        }
        .gmodal {
          top: 4%;
        }
      }
      .gq {
        border-radius: 14px;
        border: 1px solid rgba(200, 170, 110, 0.18);
        background: linear-gradient(
          180deg,
          rgba(17, 21, 30, 0.6),
          rgba(12, 16, 24, 0.45)
        );
        padding: 16px;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.38),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }
      .gq h3 {
        margin: 0 0 10px;
        color: #f2ecd5;
        font: 800 18px/1.2 Inter;
      }
      .gq p {
        margin: 0 0 12px;
        color: #b9c7da;
        font: 600 13px/1.5 Inter;
      }
      .answers {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 560px) {
        .answers {
          grid-template-columns: 1fr;
        }
      }
      .ans {
        display: flex;
        align-items: center;
        gap: 10px;
        border-radius: 12px;
        border: 1px solid #22324a;
        padding: 12px 14px;
        cursor: pointer;
        background: #0b1523;
        color: #e8e6d8;
        font: 700 13px/1.2 Inter;
      }
      .ans:hover {
        border-color: #2d4261;
        background: #0e1a2b;
      }
      .ans.correct {
        border-color: #3a2e16;
        background: linear-gradient(
          180deg,
          rgba(200, 170, 110, 0.25),
          rgba(200, 170, 110, 0.12)
        );
        color: #f8f3df;
      }
      .ans.wrong {
        border-color: #592b2b;
        background: #2a1313;
        color: #ffd4d4;
      }
      .hintbox {
        border-radius: 14px;
        border: 1px solid rgba(200, 170, 110, 0.18);
        padding: 14px;
        background: linear-gradient(
          180deg,
          rgba(17, 21, 30, 0.6),
          rgba(12, 16, 24, 0.45)
        );
      }
      .hintbox h4 {
        margin: 0 0 8px;
        color: #e9d596;
        font: 800 12px/1 Inter;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      .hintbox p {
        margin: 0;
        color: #cbd5e1;
        font: 600 12px/1.5 Inter;
      }
      .gfoot {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 10px 18px 16px;
        border-top: 1px solid #162338;
      }
      .progress {
        height: 8px;
        border-radius: 999px;
        background: #0e1622;
        border: 1px solid #22324a;
        overflow: hidden;
        flex: 1;
      }
      .progress > span {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #b8944e, #e9d596);
        box-shadow: 0 0 12px rgba(200, 170, 110, 0.55);
      }
      .gbtn {
        appearance: none;
        border: 1px solid #c8aa6e;
        background: #1b1c20;
        color: #fff;
        border-radius: 10px;
        padding: 10px 14px;
        font: 800 12px/1 Inter;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
      }
      .gcaps {
        color: #9fb0c6;
        font: 600 12px/1 Inter;
      }
      .center {
        text-align: center;
      }
      .result {
        padding: 20px;
      }
      .result h3 {
        margin: 0 0 8px;
        font: 800 22px/1.2 "Cinzel", serif;
        color: #f2ecd5;
      }
      .result p {
        margin: 0 0 10px;
        color: #cbd5e1;
      }
      .badge {
        display: inline-block;
        margin-top: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #3a2e16;
        background: linear-gradient(
          180deg,
          rgba(200, 170, 110, 0.25),
          rgba(200, 170, 110, 0.12)
        );
        color: #d9c89a;
        font: 700 11px/1 Inter;
        letter-spacing: 0.08em;
      }
      .confetti {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        border-radius: 18px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="onboard" class="onboard" aria-hidden="false">
      <div class="onboard-inner">
        <div class="ob-subtitle">Explore &amp; Discover</div>
        <h1 id="obTitle">PUSH</h1>
        <svg
          class="onboard-rule"
          viewBox="0 0 622 23"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <defs>
            <linearGradient
              id="splash-gold"
              gradientUnits="userSpaceOnUse"
              x1="0"
              y1="1"
              x2="622"
              y2="1"
            >
              <stop offset="0.05" stop-color="#785A28" stop-opacity="0" />
              <stop offset="0.50" stop-color="#C8AA6E" />
              <stop offset="0.95" stop-color="#785A28" stop-opacity="0" />
            </linearGradient>
          </defs>
          <polyline
            id="ruleMain"
            points="622,1 332.6,1 331.4,1 311.2,21.1 290.9,1 276.8,1 0,1"
            stroke="url(#splash-gold)"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <polyline
            id="ruleSub"
            points="395,1 389.6,6.4 317.7,6.4 310.8,12.7 303.8,6.4 232,6.4 227,1.4"
            stroke="#C8AA6E"
            stroke-width="1.5"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <p>
          Platform for Upholding Socio-cultural Heritage: Bridging Generations
          to Preserve Our Cultural Legacy
        </p>
        <button id="btnExplore" class="cta">
          <span class="cta-label">BEGIN EXPLORE</span>
        </button>
      </div>
    </div>
    <div class="backdrop" id="backdrop"></div>
    <aside class="sidebar" id="sidebar" aria-hidden="true">
      <div class="sb-header">
        <img id="sbIcon" alt="" />
        <div>
          <h2 id="sbTitle">Provinsi</h2>
          <div id="sbSubtitle" style="font: 12px/1.2 system-ui; color: #8aa0bb">
            Budaya & Warisan
          </div>
        </div>
      </div>
      <div class="sb-list" id="sbList"></div>
      <div class="sb-footer">
        Klik overlay untuk menutup ‚Ä¢ Scroll daftar untuk eksplor
      </div>
    </aside>
    <div class="dock" id="dock">
      <div class="dock-inner" id="dockInner" aria-label="Dock Menu">
        <div class="dock-spotlight" id="dockSpotlight"></div>
        <div class="dock-underline" id="dockUnderline"></div>
      </div>
    </div>
    <div class="music-btn" id="musicBtn">üéµ BG Music: OFF</div>
    <div class="hint">
      ‚òÅÔ∏è Awan ‚Ä¢ Hover ikon = SFX ‚Ä¢ Scroll zoom mulus ‚Ä¢ Klik ikon = Zoom offset +
      Sidebar ‚Ä¢ Tekan <b>M</b> untuk musik
    </div>
    <div id="qscrim" class="qscrim" aria-hidden="true"></div>
    <section
      id="qmodal"
      class="qmodal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="qtitle"
      aria-hidden="true"
    >
      <div class="qrow">
        <input
          id="qinput"
          class="qinput"
          type="search"
          placeholder="Cari fitur cepat‚Ä¶ (contoh: Dashboard, Game, Bakar Batu, Papeda)"
          autocomplete="off"
        />
        <div class="qk">ESC</div>
      </div>
      <div
        id="qlist"
        class="qlist"
        role="listbox"
        aria-label="Hasil pencarian"
      ></div>
      <div class="qfoot">
        <div class="qkbd">
          <span>Navigasi:</span><kbd>‚Üë</kbd><kbd>‚Üì</kbd
          ><span>&nbsp;‚Ä¢&nbsp;Pilih:</span><kbd>Enter</kbd>
        </div>
        <div>Tip: Ketik untuk memfilter ‚Ä¢ Hasil realtime</div>
      </div>
    </section>
    <div id="sscrim" class="sscrim" aria-hidden="true"></div>
    <section
      id="smodal"
      class="smodal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="stitle"
      aria-hidden="true"
    >
      <header class="shead">
        <div class="stitle" id="stitle">
          Choose Your Plan <span class="sbadge">New 2025</span>
        </div>
        <div class="sbill">
          <span>Monthly</span>
          <div
            id="billSwitch"
            class="switch"
            role="switch"
            aria-label="Billing Period"
            aria-checked="false"
            tabindex="0"
          >
            <div class="knob"></div>
          </div>
          <span
            >Yearly
            <span style="color: #e9d596; font-weight: 800">‚Äì20%</span></span
          >
        </div>
      </header>
      <div class="sbody"><div class="grid" id="planGrid"></div></div>
      <footer class="sfoot">
        <button class="sclose" id="scloseBtn">Close (Esc)</button>
        <div class="snote">
          Harga dapat berubah sewaktu-waktu. Pajak/biaya lain mengikuti
          kebijakan wilayah.
        </div>
      </footer>
    </section>
    <div id="pscrim" class="pscrim" aria-hidden="true"></div>
    <section
      id="pmodal"
      class="pmodal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="ptitle"
      aria-hidden="true"
    >
      <header class="phead">
        <div class="pheadL">
          <div class="pname" id="ptitle">User Profile</div>
          <div class="pmeta" id="pmeta">
            Kelola foto, nama tampilan, dan email
          </div>
        </div>
        <div class="pheadR">
          <button id="pCloseX" class="btn" type="button" aria-label="Close">
            Close
          </button>
        </div>
      </header>
      <div class="pbody">
        <div class="pcol sticky">
          <label
            for="pAvatarFile"
            class="avatar-drop"
            id="avatarDrop"
            tabindex="0"
            aria-label="Unggah foto profil"
          >
            <img id="pAvatar" class="avatar-preview" alt="Preview avatar" />
            <div id="pAvatarInitials" class="avatar-initials">UP</div>
            <div class="avatar-hint">
              <b>Klik / seret foto</b> ke area ini<br />PNG/JPG ‚Ä¢ Rasio 1:1
              disarankan
            </div>
          </label>
          <div class="avatar-actions">
            <label class="btn gold" for="pAvatarFile">Upload</label>
            <button id="pAvatarRemove" class="btn" type="button">Remove</button>
          </div>
        </div>
        <div class="pcol">
          <div class="fstack">
            <div class="fgroup">
              <label class="flabel" for="pName">Display Name</label>
              <input
                id="pName"
                class="input"
                type="text"
                placeholder="Nama tampilan"
                maxlength="40"
              />
              <div class="helper" id="nameHelp">
                Muncul pada sidebar dan konten yang kamu buat.
              </div>
            </div>
            <div class="fgroup">
              <label class="flabel" for="pEmail">Email</label>
              <input
                id="pEmail"
                class="input"
                type="email"
                placeholder="nama@domain.com"
                inputmode="email"
                autocomplete="email"
              />
              <div class="helper" id="emailHelp">
                Kami tidak akan membagikan email kamu.
              </div>
            </div>
          </div>
        </div>
      </div>
      <footer class="pfoot">
        <button id="pReset" class="btn danger" type="button">
          Reset to Defaults
        </button>
        <button id="pSave" class="btn gold" type="button">Save Changes</button>
      </footer>
    </section>
    <div id="gscrim" class="gscrim" aria-hidden="true"></div>
    <section
      id="gmodal"
      class="gmodal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="gtitle"
      aria-hidden="true"
    >
      <div class="confetti" id="gconfetti"></div>
      <header class="ghead">
        <div class="gtitle" id="gtitle">Mini Game: Tebak Budaya Papua</div>
        <div class="gstats">
          <div class="pill" id="gRound">Round 1/5</div>
          <div class="pill" id="gScore">Score: 0</div>
          <div class="pill" id="gStreak">Streak: 0</div>
        </div>
      </header>
      <div class="gbody">
        <article class="gq" id="gQuestion">
          <h3 id="qText">Siap bermain?</h3>
          <p id="qSub">Pilih jawaban yang benar di bawah ini.</p>
          <div class="answers" id="answers"></div>
        </article>
        <aside>
          <div class="hintbox">
            <h4>Petunjuk</h4>
            <p id="gHint">
              Budaya khas yang ditanyakan berasal dari salah satu provinsi di
              peta. Beberapa budaya bisa terdengar akrab‚Äîingat tarian, rumah
              adat, atau kulinernya.
            </p>
          </div>
          <div style="height: 12px"></div>
          <div class="hintbox">
            <h4>Kendali</h4>
            <p class="gcaps">
              Klik jawaban ‚Ä¢ Atau tekan <b>1‚Äì4</b> ‚Ä¢ Enter untuk Next
            </p>
          </div>
        </aside>
      </div>
      <footer class="gfoot">
        <button id="gQuit" class="gbtn" type="button">Quit</button>
        <div class="progress" aria-hidden="true"><span id="gProg"></span></div>
        <button id="gNext" class="gbtn" type="button">Start</button>
      </footer>
    </section>
    <div id="toast" class="toast" role="status" aria-live="polite">
      Tersimpan
    </div>
    <script>
      const ASSETS = {
        base: "base_map.png",
        overlays: {
          "Papua Barat": "Batas Papua Barat.png",
          "Papua Tengah": "Batas Papua Tengah.png",
          "Papua Selatan": "Batas Papua Selatan.png",
        },
        icons: {
          "Papua Barat": "icon-papua-barat.png",
          "Papua Tengah": "icon-papua-tengah.png",
          "Papua Selatan": "icon-papua-selatan.png",
        },
        sounds: {
          hoverSfx: "sfx-hover.mp3",
          clickSfx: "sfx-click.mp3",
          bgMusic: "bg-music.mp3",
        },
      };

      const PROVINCES = [
        {
          id: "Papua Barat",
          x: 0.885,
          y: 0.47,
          culture: [
            { t: "Tari", d: "Gat" },
            { t: "Kriya", d: "Ukiran Asmat" },
            { t: "Rumah Adat", d: "Kaki Seribu" },
          ],
        },
        {
          id: "Papua Tengah",
          x: 0.925,
          y: 0.49,
          culture: [
            { t: "Tari", d: "Wor" },
            { t: "Kuliner", d: "Papeda" },
            { t: "Musik", d: "Tifa" },
          ],
        },
        {
          id: "Papua Selatan",
          x: 0.935,
          y: 0.63,
          culture: [
            { t: "Tari", d: "Yospan" },
            { t: "Ritual", d: "Bakar Batu" },
            { t: "Busana", d: "Koteka" },
          ],
        },
      ];

      const H = 1365,
        W = 2048;
      const bounds = [
        [0, 0],
        [H, W],
      ];
      const llb = L.latLngBounds(bounds);

      const map = L.map("map", {
        crs: L.CRS.Simple,
        preferCanvas: true,
        zoomControl: false,
        scrollWheelZoom: true,
        zoomAnimation: true,
        zoomSnap: 0,
        zoomDelta: 0.12,
        wheelDebounceTime: 0,
        wheelPxPerZoomLevel: 100,
        touchZoom: true,
        doubleClickZoom: true,
        inertia: true,
        maxBounds: bounds,
        maxBoundsViscosity: 1.0,
        worldCopyJump: false,
      });

      map.createPane("borders");
      map.createPane("icons");
      L.imageOverlay(ASSETS.base, bounds).addTo(map);

      const EXTRA_ZOOM = 2.0;

      function setCoverView() {
        const z = map.getBoundsZoom(bounds, false);
        map.setMinZoom(z);
        map.setMaxZoom(z + EXTRA_ZOOM);
        if (!isFinite(map.getZoom()) || map.getZoom() < z) {
          map.setView([H / 2, W / 2], z, { animate: false });
        }
        map.setMaxBounds(bounds);
      }

      setCoverView();
      map.on("resize", setCoverView);

      (function clouds() {
        const pane = map.getPanes().overlayPane;
        const cont = L.DomUtil.create("div", "clouds-masked", pane);
        const tex1 = L.DomUtil.create("div", "cloud-tex", cont);
        const tex2 = L.DomUtil.create("div", "cloud-tex parallax", cont);

        function update() {
          const nw = map.latLngToLayerPoint(llb.getNorthWest());
          const se = map.latLngToLayerPoint(llb.getSouthEast());
          const sz = se.subtract(nw);
          L.DomUtil.setPosition(cont, nw);
          cont.style.width = sz.x + "px";
          cont.style.height = sz.y + "px";
          tex1.style.backgroundSize = `${Math.max(512, sz.x / 2)}px ${Math.max(
            512,
            sz.y / 2
          )}px`;
          tex2.style.backgroundSize = `${Math.max(
            640,
            sz.x / 1.6
          )}px ${Math.max(640, sz.y / 1.6)}px`;
        }

        update();
        map.on("move zoom viewreset resize", update);

        const TILE1 = 1024,
          TILE2 = 1280;
        const speed1 = { x: 0.9, y: 0.42 },
          speed2 = { x: 0.52, y: 0.24 };
        let x1 = 0,
          y1 = 0,
          x2 = 0,
          y2 = 0;

        gsap.ticker.add(() => {
          const dr = gsap.ticker.deltaRatio(60);
          x1 = (x1 - speed1.x * dr) % TILE1;
          y1 = (y1 - speed1.y * dr) % TILE1;
          x2 = (x2 - speed2.x * dr) % TILE2;
          y2 = (y2 - speed2.y * dr) % TILE2;
          const bx1 = (x1 + TILE1) % TILE1,
            by1 = (y1 + TILE1) % TILE1;
          const bx2 = (x2 + TILE2) % TILE2,
            by2 = (y2 + TILE2) % TILE2;
          tex1.style.backgroundPosition = `${-bx1}px ${-by1}px`;
          tex2.style.backgroundPosition = `${-bx2}px ${-by2}px`;
        });

        document.addEventListener("visibilitychange", () => {
          gsap.ticker[document.hidden ? "sleep" : "wake"]();
        });
      })();

      const borderLayers = {};
      Object.entries(ASSETS.overlays).forEach(([name, file]) => {
        const layer = L.imageOverlay(encodeURI(file), bounds, {
          pane: "borders",
          opacity: 0,
          interactive: false,
        }).addTo(map);
        layer.once("load", () => {
          const el = layer.getElement();
          el.style.mixBlendMode = "screen";
          el.style.pointerEvents = "none";
        });
        borderLayers[name] = layer;
      });

      const fadeBorder = (id, to) => {
        const layer = borderLayers[id];
        if (!layer) return;
        const img = layer.getElement();
        const from = { o: parseFloat(getComputedStyle(img).opacity) || 0 };
        anime({
          targets: from,
          o: to,
          duration: 280,
          easing: "easeOutQuad",
          update: () => {
            img.style.opacity = from.o;
          },
        });
      };

      const audio = {
        userInteracted: false,
        hover: new Audio(ASSETS.sounds.hoverSfx),
        click: new Audio(ASSETS.sounds.clickSfx),
        bg: new Audio(ASSETS.sounds.bgMusic),
        lastHoverAt: 0,
        sfxOn: true,
      };

      audio.hover.preload = "auto";
      audio.hover.volume = 0.5;
      audio.click.preload = "auto";
      audio.click.volume = 0.6;
      audio.bg.preload = "auto";
      audio.bg.loop = true;
      audio.bg.volume = 0.45;

      const musicBtn = document.getElementById("musicBtn");
      const setBtn = (on) =>
        (musicBtn.textContent = on ? "üéµ BG Music: ON" : "üéµ BG Music: OFF");

      async function startBgIfAllowed() {
        try {
          await audio.bg.play();
          setBtn(true);
        } catch (_) {
          setBtn(false);
        }
      }

      const pauseBg = () => {
        audio.bg.pause();
        setBtn(false);
      };

      window.addEventListener(
        "pointerdown",
        async () => {
          if (!audio.userInteracted) {
            audio.userInteracted = true;
            if (profileState.musicOn) await startBgIfAllowed();
          }
        },
        { once: true }
      );

      musicBtn.addEventListener("click", async () => {
        if (audio.bg.paused) await startBgIfAllowed();
        else pauseBg();
      });

      window.addEventListener("keydown", async (e) => {
        if (e.key.toLowerCase() === "m") {
          if (audio.bg.paused) await startBgIfAllowed();
          else pauseBg();
        }
      });

      const playHoverSfx = () => {
        if (!audio.userInteracted || !audio.sfxOn) return;
        const now = performance.now();
        if (now - audio.lastHoverAt < 150) return;
        audio.lastHoverAt = now;
        try {
          audio.hover.currentTime = 0;
          audio.hover.play();
        } catch (_) {}
      };

      const playClickSfx = () => {
        if (!audio.sfxOn) return;
        try {
          audio.click.currentTime = 0;
          audio.click.play();
        } catch (_) {}
      };

      const backdrop = document.getElementById("backdrop");
      const Hh = H,
        Ww = W;
      const llbb = llb;

      function computeOffsetCenter(latlng, zoom, padX = 160, padY = 130) {
        const sidebarOpen = backdrop.classList.contains("active");
        const padLeftExtra = sidebarOpen ? 120 : 0;
        const size = map.getSize();
        const half = L.point(size.x / 2, size.y / 2);
        const nwZ = map.project(llbb.getNorthWest(), zoom);
        const seZ = map.project(llbb.getSouthEast(), zoom);
        const p = map.project(latlng, zoom);
        let cx = p.x,
          cy = p.y;
        const right = seZ.x - half.x,
          left = nwZ.x + half.x,
          bottom = seZ.y - half.y,
          top = nwZ.y + half.y;
        if (p.x > right) cx = p.x - (half.x - padX);
        else if (p.x < left) cx = p.x + (half.x - (padX + padLeftExtra));
        if (p.y > bottom) cy = p.y - (half.y - padY);
        else if (p.y < top) cy = p.y + (half.y - padY);
        const eps = 1;
        const minX = nwZ.x + half.x + eps,
          maxX = seZ.x - half.x - eps,
          minY = nwZ.y + half.y + eps,
          maxY = seZ.y - half.y - eps;
        cx = Math.min(Math.max(cx, minX), maxX);
        cy = Math.min(Math.max(cy, minY), maxY);
        return map.unproject(L.point(cx, cy), zoom);
      }

      const sidebar = document.getElementById("sidebar");
      const sbIcon = document.getElementById("sbIcon");
      const sbTitle = document.getElementById("sbTitle");
      const sbSubtitle = document.getElementById("sbSubtitle");
      const sbList = document.getElementById("sbList");

      function openSidebar(prov) {
        sbIcon.src = ASSETS.icons[prov.id];
        sbTitle.textContent = prov.id;
        sbSubtitle.textContent = "Budaya & Warisan ‚Ä¢ " + prov.id;
        sbList.innerHTML = "";
        prov.culture.forEach((it) => {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.innerHTML = `<img src="${
            ASSETS.icons[prov.id]
          }" alt=""><strong>${it.t}</strong> ${it.d}`;
          sbList.appendChild(chip);
        });
        backdrop.classList.add("active");
        anime({
          targets: sidebar,
          translateX: ["-110%", "0%"],
          duration: 420,
          easing: "easeOutCubic",
        });
      }

      function closeSidebar() {
        anime({
          targets: sidebar,
          translateX: ["0%", "-110%"],
          duration: 360,
          easing: "easeInCubic",
          complete: () => {
            backdrop.classList.remove("active");
            sidebar.style.transform = "translateX(-110%)";
          },
        });
      }

      backdrop.addEventListener("click", closeSidebar);
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && backdrop.classList.contains("active")) {
          closeSidebar();
        }
      });

      PROVINCES.forEach((p) => {
        const lat = p.y * H,
          lng = p.x * W;
        const el = document.createElement("div");
        el.className = "prov-icon";
        el.innerHTML = `<img src="${ASSETS.icons[p.id]}" alt="${p.id}">`;
        const marker = L.marker([lat, lng], {
          icon: L.divIcon({
            html: el,
            className: "",
            iconSize: [56, 56],
            iconAnchor: [28, 28],
          }),
          pane: "icons",
          riseOnHover: true,
        }).addTo(map);
        marker.on("mouseover", () => {
          fadeBorder(p.id, 1);
          playHoverSfx();
        });
        marker.on("mouseout", () => fadeBorder(p.id, 0));
        marker.on("click", () => {
          playClickSfx();
          const zMax = map.getMaxZoom();
          const c = computeOffsetCenter([lat, lng], zMax);
          map.flyTo(c, zMax, {
            animate: true,
            duration: 0.85,
            easeLinearity: 0.24,
          });
          map.once("moveend", () => openSidebar(p));
        });
      });

      const onboard = document.getElementById("onboard");
      const btnExplore = document.getElementById("btnExplore");
      const iconsPane = map.getPane("icons");

      function lockInteractions(lock = true) {
        const m = map;
        if (lock) {
          m.dragging.disable();
          m.scrollWheelZoom.disable();
          m.doubleClickZoom.disable();
          m.touchZoom.disable();
        } else {
          m.dragging.enable();
          m.scrollWheelZoom.enable();
          m.doubleClickZoom.enable();
          m.touchZoom.enable();
        }
      }

      lockInteractions(true);
      iconsPane.classList.add("icons-hidden");

      function prep(poly) {
        if (!poly) return 0;
        let Lg = 0;
        try {
          Lg =
            typeof poly.getTotalLength === "function"
              ? poly.getTotalLength()
              : Math.max(
                  200,
                  Math.floor((poly.getBBox ? poly.getBBox().width : 800) * 1.2)
                );
        } catch (e) {
          Lg = 800;
        }
        poly.style.strokeDasharray = String(Lg);
        poly.style.strokeDashoffset = "0";
        return Lg;
      }

      prep(document.getElementById("ruleMain"));
      prep(document.getElementById("ruleSub"));

      gsap
        .timeline({ defaults: { ease: "power3.out" } })
        .to("#obTitle", { opacity: 1, y: 0, duration: 0.6, delay: 0.05 })
        .to(".ob-subtitle", { opacity: 1, y: 0, duration: 0.5 }, "-=.35")
        .to(
          ".onboard .onboard-rule",
          { opacity: 1, y: 0, duration: 0.45 },
          "-=.15"
        )
        .to(
          [".onboard p", "#btnExplore"],
          { opacity: 1, y: 0, duration: 0.55, stagger: 0 },
          "-=.10"
        );

      btnExplore?.addEventListener("mouseenter", () =>
        gsap.to(btnExplore, {
          y: -2,
          boxShadow: "0 6px 18px rgba(200,170,110,0.45)",
          duration: 0.25,
          ease: "power3.out",
        })
      );

      btnExplore?.addEventListener("mouseleave", () =>
        gsap.to(btnExplore, {
          y: 0,
          boxShadow: "0 8px 22px rgba(0,0,0,0.35)",
          duration: 0.25,
          ease: "power3.inOut",
        })
      );

      btnExplore?.addEventListener("click", async () => {
        playClickSfx();
        audio.userInteracted = true;
        await startBgIfAllowed();
        anime({
          targets: onboard,
          opacity: [1, 0],
          duration: 360,
          easing: "easeInOutCubic",
          complete: () => {
            onboard.style.display = "none";
          },
        });
        lockInteractions(false);
        const z = map.getMinZoom();
        const t = Math.min(map.getMaxZoom(), z + 0.9);
        map.flyTo([H / 2, W / 2], t, {
          animate: true,
          duration: 0.9,
          easeLinearity: 0.24,
        });
        map.once("moveend", () => {
          const nodes = iconsPane.querySelectorAll(".prov-icon");
          iconsPane.classList.remove("icons-hidden");
          anime({
            targets: nodes,
            opacity: [0, 1],
            translateY: [12, 0],
            scale: [0.6, 1],
            filter: ["blur(3px)", "blur(0px)"],
            delay: anime.stagger(90, { from: "center", start: 120 }),
            duration: 560,
            easing: "cubicBezier(.2,.8,.2,1)",
          });
        });
      });

      const DOCK_ITEMS = [
        {
          id: "profile",
          label: "User Profile",
          icon: "user-profile.png",
          action: () => openUserProfile(),
        },
        {
          id: "game",
          label: "Game",
          icon: "game.png",
          action: () => openGame(),
        },
        {
          id: "shortcuts",
          label: "Pintasan Cepat",
          icon: "shortcut.png",
          action: () => openQuickShortcuts(),
        },
        {
          id: "event",
          label: "Event",
          icon: "event.png",
          action: () => console.log("Open Event"),
        },
        {
          id: "dashboard",
          label: "Dashboard",
          icon: "dashboard.png",
          action: () => console.log("Open Dashboard"),
        },
        {
          id: "subscription",
          label: "Subscription",
          icon: "subscription.png",
          action: () => openSubscription(),
        },
      ];

      const dockInner = document.getElementById("dockInner");
      const underline = document.getElementById("dockUnderline");
      const spotlight = document.getElementById("dockSpotlight");
      const dockEls = [];

      DOCK_ITEMS.forEach((it) => {
        const wrap = document.createElement("div");
        wrap.className = "dock-item";
        wrap.innerHTML = `<button type="button" aria-label="${it.label}" data-id="${it.id}"><img class="dock-icon" src="${it.icon}" alt="" /><span class="dock-tip">${it.label}</span><span class="ripple" hidden></span></button>`;
        dockInner.appendChild(wrap);
        const btn = wrap.querySelector("button");
        btn.addEventListener("mouseenter", () => {
          playHoverSfx();
          wrap.classList.add("show-tip");
          gsap.to(underline, {
            opacity: 1,
            duration: 0.18,
            ease: "power2.out",
          });
        });
        btn.addEventListener("mouseleave", () =>
          wrap.classList.remove("show-tip")
        );
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          it.action?.();
          const r = wrap.querySelector(".ripple");
          r.hidden = false;
          const rect = btn.getBoundingClientRect();
          const rx = e.clientX - rect.left,
            ry = e.clientY - rect.top;
          r.style.setProperty("--rx", rx + "px");
          r.style.setProperty("--ry", ry + "px");
          gsap.fromTo(
            r,
            { opacity: 0.85 },
            {
              opacity: 0,
              duration: 0.6,
              ease: "power2.out",
              onComplete: () => {
                r.hidden = true;
              },
            }
          );
          const ring = document.createElement("span");
          ring.style.cssText = `position:absolute;left:${rx}px;top:${ry}px;width:8px;height:8px;border-radius:999px;transform:translate(-50%,-50%) scale(1);box-shadow:0 0 0 0 rgba(233,213,150,.35);pointer-events:none;`;
          r.appendChild(ring);
          gsap.to(ring, {
            duration: 0.6,
            ease: "expo.out",
            boxShadow: "0 0 0 80px rgba(233,213,150,0)",
            onComplete: () => ring.remove(),
          });
        });
        btn.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") btn.click();
        });
        dockEls.push(wrap);
      });

      gsap.set(dockInner, { opacity: 0, y: 16, filter: "blur(6px)" });
      gsap.set(dockEls, { opacity: 0, y: 10, scale: 0.92 });
      gsap
        .timeline({ defaults: { ease: "power3.out" } })
        .to(dockInner, {
          opacity: 1,
          y: 0,
          filter: "blur(0px)",
          duration: 0.55,
          delay: 0.15,
        })
        .to(
          dockEls,
          { opacity: 1, y: 0, scale: 1, duration: 0.45, stagger: 0.06 },
          "-=.25"
        );

      const sigma = 90,
        maxScale = 1.8,
        yLift = 14;
      const quick = dockEls.map((el) => ({
        s: gsap.quickTo(el, "scale", { duration: 0.18, ease: "power3.out" }),
        y: gsap.quickTo(el, "y", { duration: 0.18, ease: "power3.out" }),
      }));

      function updateMagnify(x) {
        const dockRect = dockInner.getBoundingClientRect();
        spotlight.style.setProperty("--x", `${x - dockRect.left}px`);
        let best = { idx: -1, scale: 1 };
        dockEls.forEach((el, i) => {
          const r = el.getBoundingClientRect();
          const cx = r.left + r.width / 2;
          const d = Math.abs(x - cx);
          const k = Math.exp(-(d * d) / (2 * sigma * sigma));
          const sc = 1 + (maxScale - 1) * k;
          quick[i].s(sc);
          quick[i].y(-yLift * k);
          if (sc > best.scale) best = { idx: i, scale: sc };
        });
        if (best.idx >= 0) {
          const r = dockEls[best.idx].getBoundingClientRect();
          const dockRect2 = dockInner.getBoundingClientRect();
          const w = Math.max(32, 34 + (best.scale - 1) * 18);
          const left = r.left - dockRect2.left + (r.width - w) / 2;
          gsap.to(underline, {
            left,
            width: w,
            duration: 0.22,
            ease: "power3.out",
            overwrite: true,
          });
        }
      }

      dockInner.addEventListener("mousemove", (e) => updateMagnify(e.clientX));
      dockInner.addEventListener("mouseenter", (e) => {
        spotlight.style.opacity = 1;
        updateMagnify(e.clientX);
      });
      dockInner.addEventListener("mouseleave", () => {
        spotlight.style.opacity = 0;
        gsap.to(underline, { opacity: 0, duration: 0.2 });
        dockEls.forEach((_, i) => {
          quick[i].s(1);
          quick[i].y(0);
        });
      });
      dockInner.addEventListener("mousemove", (e) => {
        const rect = dockInner.getBoundingClientRect();
        const x = e.clientX - rect.left;
        gsap.to(spotlight, {
          duration: 0.22,
          ease: "power2.out",
          "--x": x + "px",
        });
      });

      const qscrim = document.getElementById("qscrim");
      const qmodal = document.getElementById("qmodal");
      const qinput = document.getElementById("qinput");
      const qlist = document.getElementById("qlist");

      const SHORTCUTS = [
        {
          id: "open-dashboard",
          title: "Buka Dashboard",
          desc: "Pergi ke halaman dasbor analitik",
          tag: "NAV",
          icon: "dashboard.png",
          action: () => console.log("Go Dashboard"),
        },
        {
          id: "open-profile",
          title: "Profil Pengguna",
          desc: "Lihat & ubah profil",
          tag: "USER",
          icon: "user-profile.png",
          action: () => openUserProfile(),
        },
        {
          id: "open-game",
          title: "Game Mini",
          desc: "Mainkan mini-game edukasi budaya",
          tag: "FUN",
          icon: "game.png",
          action: () => openGame(),
        },
        ...PROVINCES.flatMap((p) =>
          p.culture.map((c) => ({
            id: `${p.id}-${c.t}-${c.d}`,
            title: `${c.t}: ${c.d}`,
            desc: `Budaya ‚Ä¢ ${p.id}`,
            tag: "CULTURE",
            icon: ASSETS.icons[p.id],
            action: () => {
              const lat = p.y * H,
                lng = p.x * W;
              const z = map.getMaxZoom();
              const cpos = computeOffsetCenter([lat, lng], z);
              map.flyTo(cpos, z, {
                animate: true,
                duration: 0.85,
                easeLinearity: 0.24,
              });
              map.once("moveend", () => openSidebar(p));
              closeQuickShortcuts();
            },
          }))
        ),
      ];

      let filtered = SHORTCUTS.slice(),
        activeIdx = 0;

      function renderList(items, active = 0) {
        qlist.innerHTML = "";
        items.forEach((it, idx) => {
          const node = document.createElement("div");
          node.className = "qitem";
          node.setAttribute("role", "option");
          node.setAttribute("data-id", it.id);
          node.setAttribute("tabindex", "-1");
          if (idx === active) node.setAttribute("aria-selected", "true");
          node.innerHTML = `<img class="qicon" src="${it.icon}" alt=""><div><div class="qtitle">${it.title}</div><div class="qdesc">${it.desc}</div></div><span class="qtag">${it.tag}</span>`;
          node.addEventListener("mouseenter", () => highlightIndex(idx));
          node.addEventListener("click", () => selectIndex(idx));
          qlist.appendChild(node);
        });
        activeIdx = Math.min(active, items.length - 1);
      }

      function filterList(q) {
        const s = q.trim().toLowerCase();
        filtered = !s
          ? SHORTCUTS.slice()
          : SHORTCUTS.filter((it) =>
              (it.title + " " + it.desc + " " + (it.tag || ""))
                .toLowerCase()
                .includes(s)
            );
        activeIdx = 0;
        renderList(filtered, activeIdx);
      }

      function highlightIndex(i) {
        const nodes = [...qlist.children];
        nodes.forEach((n) => n.removeAttribute("aria-selected"));
        if (nodes[i]) nodes[i].setAttribute("aria-selected", "true");
        activeIdx = i;
        if (nodes[i]) nodes[i].scrollIntoView({ block: "nearest" });
      }

      function selectIndex(i) {
        const item = filtered[i];
        if (!item) return;
        playClickSfx();
        try {
          item.action?.();
        } catch (e) {
          console.error(e);
        }
        closeQuickShortcuts();
      }

      function openQuickShortcuts() {
        qscrim.classList.add("active");
        qscrim.setAttribute("aria-hidden", "false");
        qmodal.classList.add("active");
        qmodal.setAttribute("aria-hidden", "false");
        gsap.set(qmodal, {
          opacity: 0,
          y: -12,
          scale: 0.96,
          filter: "blur(10px)",
        });
        filterList("");
        gsap.to(qmodal, {
          opacity: 1,
          y: 0,
          scale: 1,
          filter: "blur(0px)",
          duration: 0.45,
          ease: "power3.out",
        });
        setTimeout(() => qinput.focus({ preventScroll: true }), 10);
        document.documentElement.style.overflow = "hidden";
      }

      function closeQuickShortcuts() {
        gsap.to(qmodal, {
          y: -8,
          scale: 0.98,
          opacity: 0,
          filter: "blur(8px)",
          duration: 0.25,
          ease: "power2.in",
          onComplete: () => {
            qmodal.classList.remove("active");
            qmodal.setAttribute("aria-hidden", "true");
          },
        });
        qscrim.classList.remove("active");
        qscrim.setAttribute("aria-hidden", "true");
        document.documentElement.style.overflow = "";
      }

      qscrim.addEventListener("click", closeQuickShortcuts);

      window.addEventListener("keydown", (e) => {
        if (qmodal.classList.contains("active")) {
          if (e.key === "Escape") {
            e.preventDefault();
            closeQuickShortcuts();
          } else if (e.key === "ArrowDown") {
            e.preventDefault();
            highlightIndex(Math.min(activeIdx + 1, filtered.length - 1));
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            highlightIndex(Math.max(activeIdx - 1, 0));
          } else if (e.key === "Enter") {
            e.preventDefault();
            selectIndex(activeIdx);
          }
        }
      });

      qinput?.addEventListener("input", (e) => filterList(e.target.value));

      document.addEventListener("focusin", (e) => {
        if (!qmodal.classList.contains("active")) return;
        if (!qmodal.contains(e.target) && e.target !== qinput) {
          e.stopPropagation();
          qinput.focus({ preventScroll: true });
        }
      });

      const sscrim = document.getElementById("sscrim");
      const smodal = document.getElementById("smodal");
      const scloseBtn = document.getElementById("scloseBtn");
      const planGrid = document.getElementById("planGrid");
      const billSwitch = document.getElementById("billSwitch");

      const PLANS = [
        {
          key: "starter",
          name: "Starter",
          badge: "Best for Tryout",
          monthly: 49000,
          features: [
            "Akses Peta Budaya dasar",
            "3 Provinsi favorit",
            "Mode offline terbatas",
            "Email support (48h)",
          ],
        },
        {
          key: "pro",
          name: "Pro",
          badge: "Popular",
          monthly: 99000,
          features: [
            "Semua provinsi + layer batas",
            "Eksport snapshot HD",
            "Quick Shortcuts lanjutan",
            "Priority support (24h)",
          ],
        },
        {
          key: "elite",
          name: "Elite",
          badge: "For Power Users",
          monthly: 199000,
          features: [
            "Semua fitur Pro + integrasi data",
            "Ekspor video animasi awan",
            "Koleksi SFX premium",
            "VIP support (6h)",
          ],
        },
      ];

      let yearly = false,
        activePlan = "pro";
      const fmt = (n) => new Intl.NumberFormat("id-ID").format(n);
      const price = (p) =>
        yearly ? Math.round(p.monthly * 12 * 0.8) : p.monthly;
      const unit = () => (yearly ? "/tahun" : "/bulan");

      function renderPlans() {
        planGrid.innerHTML = "";
        PLANS.forEach((p) => {
          const card = document.createElement("article");
          card.className = "card" + (p.key === activePlan ? " active" : "");
          card.tabIndex = 0;
          card.dataset.key = p.key;
          card.innerHTML = `
        <div class="chead">
          <div class="cname">${p.name}</div>
          <div class="cbadge">${p.badge}</div>
        </div>
        <div class="cprice">Rp ${fmt(
          price(p)
        )} <span class="cunit">${unit()}</span></div>
        <ul class="clist">
          ${p.features.map((f) => `<li>${f}</li>`).join("")}
        </ul>
        <button class="ccta" type="button">Subscribe Now</button>
      `;
          card.addEventListener("mouseenter", () => playHoverSfx());
          card.addEventListener("click", (e) => {
            const btn = e.target.closest(".ccta");
            if (btn) {
              subscribe(p.key);
            } else {
              selectPlan(p.key);
            }
          });
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              subscribe(p.key);
            } else if (e.key === " ") {
              e.preventDefault();
              selectPlan(p.key);
            }
          });
          planGrid.appendChild(card);
        });
      }

      function selectPlan(k) {
        activePlan = k;
        [...planGrid.children].forEach((c) => {
          const on = c.dataset.key === k;
          c.classList.toggle("active", on);
          if (on)
            gsap.fromTo(
              c,
              { scale: 0.98 },
              { scale: 1, duration: 0.18, ease: "power2.out" }
            );
        });
      }

      function subscribe(k) {
        playClickSfx();
        const p = PLANS.find((x) => x.key === k);
        console.log("SUBSCRIBE:", {
          plan: p.name,
          billing: yearly ? "yearly" : "monthly",
          price: price(p),
        });
        closeSubscription();
      }

      function openSubscription() {
        sscrim.classList.add("active");
        sscrim.setAttribute("aria-hidden", "false");
        smodal.classList.add("active");
        smodal.setAttribute("aria-hidden", "false");
        gsap.set(smodal, {
          opacity: 0,
          y: -12,
          scale: 0.96,
          filter: "blur(10px)",
        });
        renderPlans();
        selectPlan(activePlan);
        gsap.to(smodal, {
          opacity: 1,
          y: 0,
          scale: 1,
          filter: "blur(0px)",
          duration: 0.45,
          ease: "power3.out",
        });
        document.documentElement.style.overflow = "hidden";
      }

      function closeSubscription() {
        gsap.to(smodal, {
          y: -8,
          scale: 0.98,
          opacity: 0,
          filter: "blur(8px)",
          duration: 0.25,
          ease: "power2.in",
          onComplete: () => {
            smodal.classList.remove("active");
            smodal.setAttribute("aria-hidden", "true");
          },
        });
        sscrim.classList.remove("active");
        sscrim.setAttribute("aria-hidden", "true");
        document.documentElement.style.overflow = "";
      }

      sscrim.addEventListener("click", closeSubscription);
      scloseBtn?.addEventListener("click", closeSubscription);

      function toggleBilling() {
        yearly = !yearly;
        billSwitch.dataset.on = yearly ? "true" : "false";
        billSwitch.setAttribute("aria-checked", yearly ? "true" : "false");
        renderPlans();
        selectPlan(activePlan);
      }

      billSwitch?.addEventListener("click", toggleBilling);
      billSwitch?.addEventListener("keydown", (e) => {
        if (e.key === " " || e.key === "Enter") {
          e.preventDefault();
          toggleBilling();
        }
      });

      window.addEventListener("keydown", (e) => {
        if (smodal.classList.contains("active")) {
          if (e.key === "Escape") {
            e.preventDefault();
            closeSubscription();
          } else if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
            e.preventDefault();
            const idx = PLANS.findIndex((p) => p.key === activePlan);
            const next =
              e.key === "ArrowRight"
                ? Math.min(idx + 1, PLANS.length - 1)
                : Math.max(idx - 1, 0);
            selectPlan(PLANS[next].key);
          } else if (e.key === "Enter") {
            e.preventDefault();
            subscribe(activePlan);
          }
        }
      });

      document.addEventListener("focusin", (e) => {
        if (!smodal.classList.contains("active")) return;
        if (!smodal.contains(e.target) && e.target !== billSwitch) {
          e.stopPropagation();
          const act =
            planGrid.querySelector(".card.active") ||
            planGrid.querySelector(".card");
          (act || smodal).focus({ preventScroll: true });
        }
      });

      const pscrim = document.getElementById("pscrim");
      const pmodal = document.getElementById("pmodal");
      const pCloseX = document.getElementById("pCloseX");

      const pName = document.getElementById("pName");
      const pEmail = document.getElementById("pEmail");

      const pAvatarFile = document.getElementById("pAvatarFile");
      const pAvatar = document.getElementById("pAvatar");
      const pAvatarRemove = document.getElementById("pAvatarRemove");
      const pAvatarInitials = document.getElementById("pAvatarInitials");
      const avatarDrop = document.getElementById("avatarDrop");

      const pReset = document.getElementById("pReset");
      const pSave = document.getElementById("pSave");
      const toast = document.getElementById("toast");

      const DEFAULT_PROFILE = {
        name: "User Profile",
        email: "",
        musicOn: false,
        sfxOn: true,
        avatarData: "",
      };

      let profileState = loadProfile();

      function loadProfile() {
        try {
          const raw = localStorage.getItem("user_profile_simple");
          const parsed = raw ? JSON.parse(raw) : DEFAULT_PROFILE;
          return { ...DEFAULT_PROFILE, ...parsed };
        } catch (_) {
          return { ...DEFAULT_PROFILE };
        }
      }

      function saveProfile(st) {
        localStorage.setItem("user_profile_simple", JSON.stringify(st));
      }

      function showToast(msg = "Tersimpan") {
        toast.textContent = msg;
        gsap.fromTo(
          toast,
          { opacity: 0, y: 16 },
          {
            opacity: 1,
            y: 0,
            duration: 0.22,
            ease: "power2.out",
            onComplete: () =>
              setTimeout(
                () =>
                  gsap.to(toast, {
                    opacity: 0,
                    y: 16,
                    duration: 0.22,
                    ease: "power2.in",
                  }),
                1100
              ),
          }
        );
      }

      function setAvatarPreview(dataURL) {
        if (dataURL) {
          pAvatar.src = dataURL;
          pAvatar.style.display = "block";
          pAvatarInitials.style.display = "none";
        } else {
          pAvatar.style.display = "none";
          const initials =
            (pName.value || profileState.name || "UP")
              .split(" ")
              .map((s) => s[0])
              .join("")
              .slice(0, 2)
              .toUpperCase() || "UP";
          pAvatarInitials.textContent = initials;
          pAvatarInitials.style.display = "grid";
        }
      }

      function applyProfileToUI() {
        if (pName) pName.value = profileState.name || "";
        if (pEmail) pEmail.value = profileState.email || "";
        setAvatarPreview(profileState.avatarData);
        audio.sfxOn = !!profileState.sfxOn;
        if (profileState.musicOn && audio.userInteracted) {
          startBgIfAllowed();
        }
      }

      function gatherProfile() {
        return {
          ...profileState,
          name: (pName?.value || "User Profile").trim(),
          email: (pEmail?.value || "").trim(),
          sfxOn: profileState.sfxOn,
          musicOn: profileState.musicOn,
          avatarData: profileState.avatarData || "",
        };
      }

      function validate() {
        const nameOK = (pName?.value || "").trim().length > 0;
        const emailVal = (pEmail?.value || "").trim();
        const emailOK =
          emailVal === "" || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVal);
        return nameOK && emailOK;
      }

      function openUserProfile() {
        pscrim.classList.add("active");
        pscrim.setAttribute("aria-hidden", "false");
        pmodal.classList.add("active");
        pmodal.setAttribute("aria-hidden", "false");
        gsap.set(pmodal, {
          opacity: 0,
          y: -12,
          scale: 0.96,
          filter: "blur(10px)",
        });
        applyProfileToUI();
        gsap.to(pmodal, {
          opacity: 1,
          y: 0,
          scale: 1,
          filter: "blur(0px)",
          duration: 0.45,
          ease: "power3.out",
        });
        document.documentElement.style.overflow = "hidden";
        setTimeout(() => pName?.focus({ preventScroll: true }), 10);
      }

      function closeUserProfile() {
        gsap.to(pmodal, {
          y: -8,
          scale: 0.98,
          opacity: 0,
          filter: "blur(8px)",
          duration: 0.25,
          ease: "power2.in",
          complete: () => {
            pmodal.classList.remove("active");
            pmodal.setAttribute("aria-hidden", "true");
          },
        });
        pscrim.classList.remove("active");
        pscrim.setAttribute("aria-hidden", "true");
        document.documentElement.style.overflow = "";
      }

      pscrim.addEventListener("click", closeUserProfile);
      pCloseX?.addEventListener("click", closeUserProfile);

      pAvatarFile?.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          profileState.avatarData = reader.result;
          setAvatarPreview(profileState.avatarData);
        };
        reader.readAsDataURL(f);
      });

      pAvatarRemove?.addEventListener("click", () => {
        profileState.avatarData = "";
        setAvatarPreview("");
      });

      ["dragenter", "dragover"].forEach((ev) =>
        avatarDrop?.addEventListener(ev, (e) => {
          e.preventDefault();
          e.stopPropagation();
          avatarDrop.style.borderColor = "#c8aa6e88";
        })
      );

      ["dragleave", "drop"].forEach((ev) =>
        avatarDrop?.addEventListener(ev, (e) => {
          e.preventDefault();
          e.stopPropagation();
          avatarDrop.style.borderColor = "#384a64";
        })
      );

      avatarDrop?.addEventListener("drop", (e) => {
        const f = e.dataTransfer.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          profileState.avatarData = reader.result;
          setAvatarPreview(profileState.avatarData);
        };
        reader.readAsDataURL(f);
      });

      avatarDrop?.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          pAvatarFile?.click();
        }
      });

      avatarDrop?.addEventListener("click", () => pAvatarFile?.click());

      function saveAndApply() {
        if (!validate()) return;
        profileState = gatherProfile();
        saveProfile(profileState);
        applyProfileToUI();
        showToast("Tersimpan");
      }

      pSave?.addEventListener("click", () => {
        playClickSfx();
        saveAndApply();
      });

      pReset?.addEventListener("click", () => {
        if (confirm("Reset profile ke default?")) {
          profileState = { ...DEFAULT_PROFILE };
          saveProfile(profileState);
          applyProfileToUI();
          showToast("Reset selesai");
        }
      });

      window.addEventListener("keydown", (e) => {
        if (pmodal.classList.contains("active")) {
          if (e.key === "Escape") {
            e.preventDefault();
            closeUserProfile();
          } else if (e.key === "Enter") {
            e.preventDefault();
            saveAndApply();
          }
        }
      });

      document.addEventListener("focusin", (e) => {
        if (!pmodal.classList.contains("active")) return;
        if (!pmodal.contains(e.target)) {
          e.stopPropagation();
          pName?.focus({ preventScroll: true });
        }
      });

      applyProfileToUI();

      const gscrim = document.getElementById("gscrim");
      const gmodal = document.getElementById("gmodal");
      const gRound = document.getElementById("gRound");
      const gScore = document.getElementById("gScore");
      const gStreak = document.getElementById("gStreak");
      const gProg = document.getElementById("gProg");
      const gNext = document.getElementById("gNext");
      const gQuit = document.getElementById("gQuit");
      const qText = document.getElementById("qText");
      const qSub = document.getElementById("qSub");
      const answersWrap = document.getElementById("answers");
      const gHint = document.getElementById("gHint");
      const gconfetti = document.getElementById("gconfetti");

      const ROUNDS = 5;
      let round = 0,
        score = 0,
        streak = 0,
        locked = false,
        currentCorrect = null,
        roundData = null;

      function openGame() {
        gscrim.classList.add("active");
        gscrim.setAttribute("aria-hidden", "false");
        gmodal.classList.add("active");
        gmodal.setAttribute("aria-hidden", "false");
        gsap.set(gmodal, {
          opacity: 0,
          y: -12,
          scale: 0.96,
          filter: "blur(10px)",
        });
        gsap.to(gmodal, {
          opacity: 1,
          y: 0,
          scale: 1,
          filter: "blur(0px)",
          duration: 0.45,
          ease: "power3.out",
        });
        document.documentElement.style.overflow = "hidden";
        resetGame();
      }

      function closeGame() {
        gsap.to(gmodal, {
          y: -8,
          scale: 0.98,
          opacity: 0,
          filter: "blur(8px)",
          duration: 0.22,
          ease: "power2.in",
          onComplete: () => {
            gmodal.classList.remove("active");
            gmodal.setAttribute("aria-hidden", "true");
          },
        });
        gscrim.classList.remove("active");
        gscrim.setAttribute("aria-hidden", "true");
        document.documentElement.style.overflow = "";
      }

      gscrim.addEventListener("click", closeGame);
      gQuit?.addEventListener("click", closeGame);

      function resetGame() {
        round = 0;
        score = 0;
        streak = 0;
        updateStats();
        if (gNext) gNext.textContent = "Start";
        if (qText) qText.textContent = "Siap bermain?";
        if (qSub) qSub.textContent = "Tebak budaya milik provinsi yang tepat.";
        if (answersWrap) answersWrap.innerHTML = "";
        if (gProg) gProg.style.width = "0%";
      }

      function updateStats() {
        if (gRound)
          gRound.textContent = `Round ${Math.min(round + 1, ROUNDS)}/${ROUNDS}`;
        if (gScore) gScore.textContent = `Score: ${score}`;
        if (gStreak) gStreak.textContent = `Streak: ${streak}`;
      }

      function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function pickQuestion() {
        const prov = PROVINCES[Math.floor(Math.random() * PROVINCES.length)];
        const item =
          prov.culture[Math.floor(Math.random() * prov.culture.length)];
        const other = PROVINCES.filter((p) => p.id !== prov.id).map(
          (p) => p.id
        );
        const distract = shuffle(other).slice(0, 2);
        const choices = shuffle([prov.id, ...distract]);
        return {
          question: `${item.t}: ${item.d}`,
          answer: prov.id,
          choices,
          hint: `Kategori: ${item.t}. Coba ingat persebaran suku & tradisi: ${prov.id} memiliki ${item.d} yang terkenal.`,
        };
      }

      function renderQuestion() {
        roundData = pickQuestion();
        currentCorrect = roundData.answer;
        if (qText) qText.textContent = "Budaya milik provinsi mana?";
        if (qSub) qSub.textContent = roundData.question;
        if (gHint) gHint.textContent = roundData.hint;
        if (answersWrap) answersWrap.innerHTML = "";
        roundData.choices.forEach((opt, idx) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "ans";
          btn.innerHTML = `<span style="opacity:.7;">${idx + 1}.</span> ${opt}`;
          btn.addEventListener("mouseenter", playHoverSfx);
          btn.addEventListener("click", () => selectAnswer(opt, btn));
          answersWrap.appendChild(btn);
        });
        locked = false;
      }

      function celebrate() {
        for (let i = 0; i < 18; i++) {
          const s = document.createElement("span");
          const x = Math.random() * 100,
            rot = (Math.random() * 360) | 0;
          s.style.cssText = `position:absolute; left:${x}%; top:-10px; width:8px; height:12px; border-radius:2px; background:linear-gradient(180deg,#e9d596,#b8944e); transform:rotate(${rot}deg);`;
          gconfetti.appendChild(s);
          gsap.to(s, {
            y: gmodal.clientHeight + 40,
            x: Math.random() * 120 - 60,
            rotation: rot + 360,
            duration: 1.6 + Math.random() * 0.9,
            ease: "power2.out",
            onComplete: () => s.remove(),
          });
        }
      }

      function selectAnswer(opt, node) {
        if (locked) return;
        locked = true;
        playClickSfx();
        const nodes = [...answersWrap.querySelectorAll(".ans")];
        nodes.forEach((n) => (n.disabled = true));
        const correct = opt === currentCorrect;
        if (correct) {
          node.classList.add("correct");
          score += 100 + Math.min(200, streak * 20);
          streak++;
          celebrate();
        } else {
          node.classList.add("wrong");
          nodes
            .find((n) => n.textContent.includes(currentCorrect))
            ?.classList.add("correct");
          streak = 0;
        }
        updateStats();
        gsap.fromTo(
          node,
          { scale: 0.98 },
          { scale: 1, duration: 0.16, ease: "power2.out" }
        );
        gProg.style.width = `${((round + 1) / ROUNDS) * 100}%`;
        gNext.textContent = round + 1 >= ROUNDS ? "Finish" : "Next";
      }

      function showResult() {
        const accuracy = Math.round((score / (ROUNDS * 100)) * 100);
        const msg =
          accuracy >= 80
            ? "Kamu Panutan Budaya! üëë"
            : accuracy >= 60
            ? "Mantap! Terus Eksplor üëè"
            : "Ayo Coba Lagi üîÅ";
        answersWrap.innerHTML = `
      <div class="result center">
        <h3>${msg}</h3>
        <p>Skor akhir: <b>${score}</b> dari maksimal ${ROUNDS * 300}</p>
        <div class="badge">Akurasi ~ ${accuracy}%</div>
      </div>
    `;
        qText.textContent = "Selesai!";
        qSub.textContent = "Mau main lagi? Tekan Replay.";
        gNext.textContent = "Replay";
      }

      gNext?.addEventListener("click", () => {
        if (gNext.textContent === "Start") {
          round = 0;
          score = 0;
          streak = 0;
          updateStats();
          gProg.style.width = "0%";
          gNext.textContent = "Next";
          renderQuestion();
          return;
        }
        if (gNext.textContent === "Replay") {
          round = 0;
          score = 0;
          streak = 0;
          updateStats();
          gProg.style.width = "0%";
          gNext.textContent = "Next";
          renderQuestion();
          return;
        }
        if (round + 1 > ROUNDS - 1) {
          showResult();
          return;
        }
        round++;
        updateStats();
        renderQuestion();
      });

      window.addEventListener("keydown", (e) => {
        if (!gmodal.classList.contains("active")) return;
        if (e.key === "Escape") {
          e.preventDefault();
          closeGame();
          return;
        }
        if (["1", "2", "3", "4"].includes(e.key)) {
          const idx = parseInt(e.key, 10) - 1;
          const node = answersWrap.querySelectorAll(".ans")[idx];
          if (node) node.click();
        } else if (e.key === "Enter") {
          gNext.click();
        }
      });

      function openSidebarIf(provId) {
        const prov = PROVINCES.find((p) => p.id === provId);
        if (!prov) return;
        const lat = prov.y * H,
          lng = prov.x * W;
        const z = map.getMaxZoom();
        const c = computeOffsetCenter([lat, lng], z);
        map.flyTo(c, z, { animate: true, duration: 0.6, easeLinearity: 0.24 });
        map.once("moveend", () => openSidebar(prov));
      }
    </script>
  </body>
</html>
